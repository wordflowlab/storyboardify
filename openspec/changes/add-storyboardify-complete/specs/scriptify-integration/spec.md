# Scriptify Integration Specification

## Overview

This capability ensures seamless data exchange between Scriptify (screenplay tool) and Storyboardify (storyboard tool) through standardized JSON format and bi-directional synchronization.

## ADDED Requirements

### Requirement: Scriptify JSON Import

The system SHALL import and parse Scriptify export JSON files conforming to v1.0 schema.

#### Scenario: Complete JSON import

- **WHEN** user imports a Scriptify JSON file with all standard fields populated
- **THEN** system extracts:
  - `meta`: version, type, created_at, tool, tool_version
  - `project`: name, type, episodes, genre
  - `characters[]`: id, name, age, role, appearance, personality, drawing_prompt
  - `scenes[]`: id, name, location, time, weather, atmosphere, color_scheme, drawing_prompt
  - `scripts[]`: episode, content, word_count, format
- **AND** validates required fields are present
- **AND** displays import summary: "成功导入项目'心理游戏',包含3个角色,5个场景,1集剧本"

#### Scenario: Partial data import

- **WHEN** Scriptify JSON lacks optional fields (e.g., `drawing_prompt` not generated by Scriptify)
- **THEN** system imports available fields successfully
- **AND** generates missing fields (e.g., drawing_prompt) using Storyboardify's generation logic
- **AND** marks auto-generated fields with `[Auto-generated by Storyboardify]` tag

#### Scenario: Version compatibility check

- **WHEN** importing JSON with `meta.version === '1.0'`
- **THEN** proceeds with standard parsing
- **WHEN** importing JSON with `meta.version === '1.1'` (future version)
- **THEN** displays warning: "Scriptify v1.1 detected. Storyboardify supports v1.0. Some features may not import correctly."
- **AND** attempts parsing with fallback to v1.0 schema
- **WHEN** importing JSON with `meta.version < '1.0'` (legacy)
- **THEN** displays error: "Incompatible Scriptify version. Please upgrade Scriptify to v0.5.0+ and re-export."

### Requirement: Character Data Mapping

The system SHALL map imported character data to production pack character sheets.

#### Scenario: Character appearance expansion

- **WHEN** Scriptify character has minimal appearance (e.g., `appearance: { clothing: ["黑色风衣"] }`)
- **THEN** Storyboardify expands to full appearance spec:
  - Infers height, hair, clothing details from personality/role
  - Adds physical attributes missing in Scriptify
  - Generates detailed drawing prompt
- **AND** preserves original Scriptify data in `[Original from Scriptify]` section
- **AND** marks expansions with `[Expanded by Storyboardify]`

#### Scenario: Character ID stability

- **WHEN** character has `id: "char_001"` in Scriptify JSON
- **THEN** Storyboardify maintains same ID throughout processing
- **AND** uses ID for cross-referencing in shots (e.g., "画面内容: char_001 stands...")
- **AND** enables character consistency across re-imports

### Requirement: Scene Data Mapping

The system SHALL map imported scene data to production pack scene sheets.

#### Scenario: Scene color scheme generation

- **WHEN** Scriptify scene lacks `color_scheme` field
- **THEN** Storyboardify generates color palette from `atmosphere` keywords
- **WHEN** Scriptify scene has predefined `color_scheme: ["暗蓝", "灰黑"]`
- **THEN** Storyboardify uses provided scheme as base
- **AND** expands to hex codes: `暗蓝 → #1a1a2e, 灰黑 → #2d2d2d`

#### Scenario: Lighting setup inference

- **WHEN** Scriptify scene has `time: "夜晚22:00"` and `weather: "下雨"`
- **THEN** Storyboardify infers lighting:
  - Light source: 街灯, 霓虹灯
  - Direction: Top-down (街灯), Multi-directional (霓虹)
  - Intensity: Low (夜晚)
  - Mood: Dark, moody, cinematic

### Requirement: Script Content Parsing

The system SHALL parse Scriptify Markdown script content to extract scene structure and dialogue.

#### Scenario: Standard markdown script parsing

- **WHEN** Scriptify script follows standard format:
  ```markdown
  ## 场景 1: 雨夜街头

  【旁白】这是一个没有月亮的夜晚。

  主角李墨独自走在街头,雨水打湿了他的风衣。

  李墨: "又是一个难眠之夜..."
  ```
- **THEN** Storyboardify extracts:
  - Scene header: "雨夜街头"
  - Narration: "这是一个没有月亮的夜晚。"
  - Action: "主角李墨独自走在街头,雨水打湿了他的风衣。"
  - Dialogue: { speaker: "李墨", text: "又是一个难眠之夜..." }

#### Scenario: Dialogue speaker matching

- **WHEN** script contains dialogue: `李墨: "..."`
- **THEN** matches speaker name to imported character ID
- **AND** links dialogue to `char_001` (李墨)
- **AND** uses character appearance for shot generation (e.g., "李墨 wearing black trench coat")

### Requirement: Data Schema Compatibility

The system SHALL maintain forward and backward compatibility with Scriptify JSON schema evolution.

#### Scenario: Forward compatibility (Scriptify adds new fields)

- **WHEN** Scriptify v1.1 adds `characters[].backstory` field not in v1.0
- **THEN** Storyboardify v1.0 ignores unknown field (does not error)
- **AND** preserves field in re-export (pass-through)
- **WHEN** Storyboardify is upgraded to support `backstory`
- **THEN** uses field for enhanced character sheet generation

#### Scenario: Backward compatibility (Storyboardify supports legacy)

- **WHEN** importing Scriptify v0.9 JSON with old schema
- **THEN** Storyboardify applies migration:
  - Maps old field names to new schema
  - Fills missing required fields with defaults
  - Logs migration warnings: "Migrated from v0.9 → v1.0. Review imported data for accuracy."

#### Scenario: Schema validation error handling

- **WHEN** JSON fails schema validation (e.g., missing required `meta.version`)
- **THEN** displays detailed error:
  ```
  ❌ Schema validation failed:
  - Missing required field: meta.version
  - Invalid field type: characters[0].age (expected number, got string)

  Please ensure you exported from Scriptify v0.5.0+ using the /export command.
  ```

### Requirement: Storyboardify Export for Scriptify

The system SHALL export storyboard data in a format compatible with future Scriptify import (bi-directional sync).

#### Scenario: Storyboardify export JSON

- **WHEN** user exports storyboard with `--format json --scriptify-compatible`
- **THEN** generates JSON:
  ```json
  {
    "meta": {
      "version": "1.0",
      "type": "storyboardify_export",
      "created_at": "2025-10-30T10:00:00Z",
      "tool": "storyboardify",
      "tool_version": "0.1.0"
    },
    "project": { ... },
    "storyboard": {
      "workspace": "manga",
      "scenes": [ ... ],
      "shots": [ ... ]
    },
    "production_pack": {
      "characters": [ ... ],
      "scenes": [ ... ],
      "prompts": [ ... ]
    }
  }
  ```
- **AND** includes character/scene updates made in Storyboardify

#### Scenario: Character appearance updates sync

- **WHEN** user refines character appearance in Storyboardify (e.g., adds hair details)
- **THEN** export includes updated `characters[].appearance`
- **AND** marks as `source: "storyboardify_refined"`
- **WHEN** reimported to Scriptify (future feature)
- **THEN** Scriptify offers to update character sheet with refined details

### Requirement: Data Integrity and Consistency

The system SHALL ensure data integrity during import and prevent data loss.

#### Scenario: Import validation before processing

- **WHEN** importing Scriptify JSON
- **THEN** performs pre-import validation:
  - JSON syntax validity
  - Schema conformance
  - Character/Scene ID uniqueness
  - Referential integrity (script references valid character/scene IDs)
- **AND** only proceeds if all validations pass
- **AND** displays validation report before confirmation

#### Scenario: Import conflict detection

- **WHEN** importing into existing Storyboardify project with same `project.name`
- **THEN** detects conflict and offers options:
  1. "覆盖现有项目 (数据将丢失)"
  2. "合并数据 (保留现有+导入新增)"
  3. "创建新项目 (添加后缀 -imported)"
- **AND** creates backup before overwrite

#### Scenario: Character/Scene ID collision

- **WHEN** imported character ID matches existing character but with different data
- **THEN** prompts user:
  ```
  ⚠️ 角色冲突:
  - 现有: char_001 (李墨, 30岁, 黑色风衣)
  - 导入: char_001 (李墨, 32岁, 灰色风衣)

  选择:
  1. 保留现有
  2. 使用导入数据
  3. 手动合并
  ```

### Requirement: Import Performance

The system SHALL handle large Scriptify exports efficiently.

#### Scenario: Large project import (50+ characters, 100+ scenes)

- **WHEN** importing JSON with 50 characters and 100 scenes
- **THEN** completes import in <5 seconds
- **AND** displays progress: "导入中... 角色 25/50, 场景 60/100"
- **AND** uses streaming JSON parser to avoid memory issues

#### Scenario: Incremental import (delta updates)

- **WHEN** Scriptify adds 2 new characters and re-exports
- **THEN** Storyboardify detects delta:
  - "检测到 2 个新角色,其他数据未变化"
  - "仅导入新增角色? (Y/n)"
- **AND** skips re-processing unchanged data (saves time)

## Implementation Notes

- Import logic MUST support both Scriptify v0.5.0 JSON and future v1.x versions
- Character/Scene IDs SHOULD use UUID format for guaranteed uniqueness
- Bi-directional sync MAY require Scriptify v2.0 collaboration (future roadmap)
- Schema migration logic SHOULD be versioned and tested against real Scriptify exports
- Import performance SHOULD be benchmarked with 100+ character/scene datasets
