/**
 * AI驱动的分镜生成器 - Express模式
 * 基于场景拆分和运镜优化,生成完整的AI驱动分镜脚本
 */

import type {
  Storyboard,
  Scene,
  Shot,
  ProductionPack,
  CharacterSheet,
  SceneSheet,
  WorkspaceType,
} from '../types/index.js';
import { splitSceneIntoShots, type SceneSplitResult } from './scene-splitter.js';
import { optimizeCameraParameters, type CameraOptimizationContext } from './camera-optimizer.js';
import { WORKSPACE_CONFIGS } from '../workspaces/configs.js';

export interface AIStoryboardOptions {
  workspace: WorkspaceType;
  style_preference?: 'cinematic' | 'dynamic' | 'minimal'; // 风格偏好
  detail_level?: 'basic' | 'detailed' | 'comprehensive'; // 细节程度
}

/**
 * 从场景内容提取关键信息
 */
function extractSceneElements(scene: Scene): {
  characters: string[];
  actions: string[];
  dialogues: string[];
  emotions: string[];
} {
  const content = scene.content;

  // 提取角色(简单实现,实际可用NLP)
  const character_matches = content.match(/([A-Z][a-z]+|[\u4e00-\u9fa5]{2,4}):/g) || [];
  const characters = [...new Set(character_matches.map(m => m.replace(':', '')))];

  // 提取动作
  const action_keywords = ['走', '跑', '坐', '站', '转身', '推开', '拿起', '放下', '看向', '离开'];
  const actions = action_keywords.filter(kw => content.includes(kw));

  // 提取对话
  const dialogue_pattern = /[「『"]([^」』"]+)[」』"]/g;
  const dialogues: string[] = [];
  let match;
  while ((match = dialogue_pattern.exec(content)) !== null) {
    dialogues.push(match[1]);
  }

  // 提取情绪
  const emotion_keywords = ['愤怒', '悲伤', '喜悦', '紧张', '平静', '恐惧', '惊讶', '困惑'];
  const emotions = emotion_keywords.filter(kw => content.includes(kw));

  return { characters, actions, dialogues, emotions };
}

/**
 * 为单个镜头生成详细内容
 */
function generateShotContent(
  scene: Scene,
  sceneSheet: SceneSheet,
  characterSheets: CharacterSheet[],
  shot_plan: SceneSplitResult['shot_plans'][0],
  shot_index: number,
  total_shots: number
): Partial<Shot> {
  const { characters, actions, dialogues } = extractSceneElements(scene);
  const progress = shot_index / total_shots;

  // 生成镜头内容描述
  let content_parts: string[] = [];

  // 如果是开场镜头,描述环境
  if (shot_index === 0) {
    content_parts.push(`${scene.name}。${sceneSheet.layout_description}`);
  }

  // 添加角色和动作
  if (characters.length > 0 && shot_index < characters.length) {
    const char_name = characters[shot_index];
    const char_sheet = characterSheets.find(cs => cs.name === char_name);
    if (char_sheet) {
      content_parts.push(`${char_name}${char_sheet.appearance.build || ''}`);
    }
  }

  // 添加对话(如果有)
  if (dialogues.length > 0 && shot_index < dialogues.length) {
    content_parts.push(`对话: "${dialogues[shot_index]}"`);
  }

  // 添加动作(如果有)
  if (actions.length > 0) {
    const action_index = shot_index % actions.length;
    content_parts.push(`动作: ${actions[action_index]}`);
  }

  // 如果没有足够内容,使用场景内容片段
  if (content_parts.length < 2) {
    const scene_length = scene.content.length;
    const start = Math.floor((progress * scene_length));
    const end = Math.min(start + 100, scene_length);
    const snippet = scene.content.substring(start, end);
    content_parts.push(snippet);
  }

  return {
    shot_number: shot_index + 1,
    shot_type: shot_plan.suggested_shot_type as Shot['shot_type'],
    camera_angle: shot_plan.suggested_angle as Shot['camera_angle'],
    content: content_parts.join('。'),
  };
}

/**
 * 生成情绪标注
 */
function generateMoodAnnotation(
  scene: Scene,
  shot_index: number,
  total_shots: number
): Shot['mood'] {
  const { emotions } = extractSceneElements(scene);
  const progress = shot_index / total_shots;

  let emotional_tone = '平静';
  if (emotions.length > 0) {
    // 根据进度选择情绪
    const emotion_index = Math.floor(progress * emotions.length);
    emotional_tone = emotions[emotion_index] || emotions[0];
  }

  return {
    emotional_tone,
    lighting_suggestion: emotional_tone.includes('紧张') || emotional_tone.includes('恐惧')
      ? '低调照明,强对比'
      : emotional_tone.includes('喜悦')
        ? '明亮柔和'
        : '自然光',
    color_grading: emotional_tone.includes('悲伤')
      ? '冷色调,低饱和度'
      : emotional_tone.includes('愤怒')
        ? '暖色调,高对比'
        : '中性色调',
  };
}

/**
 * 生成动态效果
 */
function generateShotEffects(shot_type: string, pacing: string): Shot['effects'] {
  return {
    speed_ramp: pacing === 'fast' ? '快进' : undefined,
    blur: shot_type.includes('特写') ? '背景虚化' : undefined,
    color_filter: undefined,
  };
}

/**
 * 生成工作区特定字段
 */
function generateWorkspaceFields(
  workspace: WorkspaceType,
  shot_index: number,
  total_shots: number
): Shot['workspace_fields'] {
  const config = WORKSPACE_CONFIGS[workspace];

  if (workspace === 'manga') {
    // 漫画工作区
    const is_page_break = (shot_index + 1) % 4 === 0; // 每4个镜头翻页
    return {
      page_break: is_page_break,
      bubble_position: shot_index % 2 === 0 ? '左上' : '右上',
      panel_layout: shot_index % 3 === 0 ? '全页' : '半页',
    };
  } else if (workspace === 'short-video') {
    // 短视频工作区
    const timeline_seconds = shot_index * 3; // 每个镜头3秒
    const minutes = Math.floor(timeline_seconds / 60);
    const seconds = timeline_seconds % 60;
    return {
      timeline: `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`,
      subtitle: '字幕内容待填充',
      subtitle_style: {
        font: 'PingFang SC',
        size: 24,
        color: '#FFFFFF',
        position: 'bottom-center',
      },
      voiceover: {
        voice_type: 'neutral',
        speed: 1.0,
        volume: 0.8,
      },
    };
  } else if (workspace === 'dynamic-manga') {
    // 动态漫工作区
    return {
      frame_range: `${shot_index * 24}-${(shot_index + 1) * 24}`, // 24fps
      layer_structure: ['背景层', '人物层', '特效层', '字幕层'],
      params_3d: {
        camera_fov: 50,
        camera_distance: 10,
      },
      vfx_params: {
        particle_effects: [],
        screen_effects: [],
      },
    };
  }

  return undefined;
}

/**
 * Express模式: 完全自动生成分镜
 */
export async function generateExpressStoryboard(
  productionPack: ProductionPack,
  options: AIStoryboardOptions
): Promise<Storyboard> {
  const { character_sheets, scene_sheets, source_data } = productionPack;
  const scenes = source_data.scenes;

  console.log(`\n🚀 Express模式: 开始AI驱动分镜生成...\n`);

  // 1. 生成场景拆分规划
  console.log('📊 步骤 1/4: 分析场景复杂度并生成镜头规划...');
  const split_results = scenes.map(scene => {
    const sheet = scene_sheets.find(s => s.scene_id === scene.id);
    return splitSceneIntoShots(scene, sheet);
  });

  const total_shots = split_results.reduce((sum, r) => sum + r.estimated_shots, 0);
  console.log(`   ✓ 规划完成: ${scenes.length}个场景, 预计${total_shots}个镜头\n`);

  // 2. 为每个场景生成镜头
  console.log('🎬 步骤 2/4: 生成详细镜头内容...');
  const storyboard_scenes: Storyboard['scenes'] = [];
  let global_shot_number = 1;

  for (const [scene_index, scene] of scenes.entries()) {
    const split_result = split_results[scene_index];
    const scene_sheet = scene_sheets.find(s => s.scene_id === scene.id)!;

    console.log(`   场景 ${scene_index + 1}/${scenes.length}: ${scene.name} (${split_result.estimated_shots}个镜头, ${split_result.pacing}节奏)`);

    const shots: Shot[] = [];

    for (const [shot_index, shot_plan] of split_result.shot_plans.entries()) {
      // 生成基础镜头内容
      const shot_base = generateShotContent(
        scene,
        scene_sheet,
        character_sheets,
        shot_plan,
        shot_index,
        split_result.estimated_shots
      );

      // 优化运镜参数
      const shot_position: CameraOptimizationContext['shot_position'] =
        shot_index === 0
          ? 'opening'
          : shot_index === split_result.estimated_shots - 1
            ? 'closing'
            : shot_index / split_result.estimated_shots > 0.6
              ? 'climax'
              : 'middle';

      const optimized_camera = optimizeCameraParameters({
        shot_type: shot_base.shot_type!,
        scene_pacing: split_result.pacing,
        mood: undefined,
        is_dialogue: shot_base.content?.includes('对话') || false,
        is_action: shot_base.content?.includes('动作') || false,
        shot_position,
      });

      // 组装完整镜头
      const shot: Shot = {
        shot_number: global_shot_number++,
        shot_type: shot_base.shot_type!,
        camera_angle: optimized_camera.angle.type,
        content: shot_base.content!,
        camera_movement: {
          type: optimized_camera.movement.type,
          speed: optimized_camera.movement.speed,
          description: optimized_camera.movement.description,
        },
        mood: generateMoodAnnotation(scene, shot_index, split_result.estimated_shots),
        effects: generateShotEffects(shot_base.shot_type!, split_result.pacing),
        workspace_fields: generateWorkspaceFields(
          options.workspace,
          shot_index,
          split_result.estimated_shots
        ),
      };

      shots.push(shot);
    }

    storyboard_scenes.push({
      scene_id: scene.id,
      scene_name: scene.name,
      shots,
    });
  }

  console.log(`   ✓ ${total_shots}个镜头生成完成\n`);

  // 3. 生成元数据
  console.log('📝 步骤 3/4: 生成元数据...');
  const workspace_config = WORKSPACE_CONFIGS[options.workspace];

  let estimated_duration: string | undefined;
  let estimated_pages: string | undefined;

  if (options.workspace === 'short-video' || options.workspace === 'dynamic-manga') {
    const total_seconds = total_shots * 3; // 假设每个镜头3秒
    const minutes = Math.floor(total_seconds / 60);
    const seconds = total_seconds % 60;
    estimated_duration = `${minutes}分${seconds}秒`;
  }

  if (options.workspace === 'manga') {
    estimated_pages = `${Math.ceil(total_shots / 4)}页`; // 假设每页4格
  }

  console.log(`   ✓ 预估${estimated_duration || estimated_pages || '完成'}\n`);

  // 4. 组装完整分镜脚本
  console.log('✅ 步骤 4/4: 组装分镜脚本...\n');

  const storyboard: Storyboard = {
    version: '1.0',
    metadata: {
      title: source_data.scripts[0]?.title || '未命名',
      workspace: options.workspace,
      workspace_display_name: workspace_config.display_name,
      aspect_ratio: workspace_config.aspect_ratio,
      total_scenes: scenes.length,
      total_shots,
      estimated_duration,
      estimated_pages,
      generation_mode: 'express',
      created_at: new Date().toISOString(),
    },
    scenes: storyboard_scenes,
    production_pack_reference: {
      characters: character_sheets.map(cs => cs.id),
      scenes: scene_sheets.map(ss => ss.scene_id),
    },
  };

  console.log('🎉 Express模式分镜生成完成!\n');
  console.log(`总计: ${scenes.length}个场景, ${total_shots}个镜头`);
  console.log(`工作区: ${workspace_config.display_name}`);
  console.log(`预估: ${estimated_duration || estimated_pages || 'N/A'}\n`);

  return storyboard;
}
